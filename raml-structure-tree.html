<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../raml-behaviors/raml-behavior.html">
<link rel="import" href="raml-resource-tree-item.html">
<link rel="import" href="raml-documentation-tree-item.html">
<link rel="import" href="raml-type-tree-item.html">
<link rel="import" href="raml-tree-item-styles.html">
<!--
The `<raml-structure-tree>` renders a list view for the `<raml-path-selector>`.
See docs for `<raml-path-selector>` for element's documentation.
-->
<dom-module id="raml-structure-tree">
  <template>
    <style include="raml-tree-item-styles">
     :host {
      display: block;
      background: var(--raml-path-selector-background-color, --primary-background-color);
      color: var(--raml-path-selector-color, --primary-text-color);
      overflow: auto;
      @apply(--raml-path-selector);
    }

    h3 {
      @apply(--paper-font-subhead);
      color: rgba(0, 0, 0, 0.54);
      padding-left: 14px;
      @apply(--raml-path-selector-headers);
    }
    </style>
    <paper-item on-tap="_selectSummary" class$="[[_computeItemSelectedClass(selectedPath, 'summary')]]" title="API sumamry">Summary</paper-item>
    <h3 hidden$="[[!hasDocumentation]]">Documentation</h3>
    <template is="dom-repeat" items="[[raml.documentation]]">
      <raml-documentation-tree-item indent="1" indent-size="12" selected-path="[[selectedPath]]" doc="[[item]]" path="documentation.[[index]]"></raml-documentation-tree-item>
    </template>
    <h3 hidden$="[[!hasTypes]]">Types</h3>
    <template is="dom-repeat" items="[[_objectToArray(raml.types)]]">
      <raml-type-tree-item indent="1" indent-size="12" selected-path="[[selectedPath]]" type="[[item]]" path="types.[[index]]"></raml-type-tree-item>
    </template>
    <h3 hidden$="[[!hasResources]]">Resources</h3>
    <template is="dom-repeat" items="[[raml.resources]]" resources>
      <raml-resource-tree-item
        selected-path="[[selectedPath]]"
        resource="[[item]]"
        path="resources.[[index]]"
        opened="[[opened]]"></raml-resource-tree-item>
    </template>
  </template>
  <script>
  Polymer({
    is: 'raml-structure-tree',
    behaviors: [Polymer.RamlBehavior],

    /**
     * Fired when the path change.
     *
     * @event raml-selected-path-changed
     * @param {String} path The selected path
     */

    properties: {
      // Currently selected by the user path.
      selectedPath: {
        type: String,
        notify: true
      },
      // If true then the first level of resources will be opened by default.
      opened: {
        type: Boolean,
        value: false
      },
      // Is set to true when the RAML's `resources` array is not empty
      hasDocumentation: Boolean,
      // Is set to true when the RAML's `documentation` array is not empty
      hasResources: Boolean,
      /**
       * Set to true when the RAML's `types` array is not empty
       * and the path selector should render types list.
       */
      hasTypes: Boolean,
      /**
       * If set it will renders the view in the narrow layout.
       */
      narrow: {
        type: Boolean,
        value: false,
        notify: true,
        reflectToAttribute: true
      },

      // A widith below which the `narrow` property will be set to true.
      narrowWidth: {
        type: String,
        value: '768px'
      }
    },

    hostAttributes: {
      role: 'listbox',
      tabindex: '0'
    },

    listeners: {
      'raml-path-selected': '_onPathSelected'
    },

    observers: [
      '_patchChanged(selectedPath)',
      '_ramlChanged(raml)'
    ],

    // Sets the `selectedPath` value form the `raml-path-selected` event.
    _onPathSelected: function(e) {
      e.stopPropagation();
      this.set('selectedPath', e.detail.path);
    },

    // Fires the `raml-selected-path-changed` event when the path changes.
    _patchChanged: function(selectedPath) {
      this.fire('raml-selected-path-changed', {
        path: selectedPath
      });
    },

    /**
     * Sets the path to the first available item.
     */
    _ramlChanged: function(raml) {
      if (!raml) {
        this.set('selectedPath', '');
      } else {
        this._selectSummary();
      }
    },

    _computeItemSelectedClass: function(selectedPath, itemsPath) {
      return selectedPath === itemsPath ? 'selected' : '';
    },

    _selectSummary: function() {
      this.set('selectedPath', 'summary');
    },

    /**
     * Transforms Object to Array and sets a `key` property on each
     * array item as an original key name from the object.
     *
     * @param {Object} obj The object to translate to array
     * @return {Array|undefined} Array or undefined if not passed an object.
     */
    _objectToArray: function(obj) {
      if (!obj) {
        return;
      }
      var keys = Object.keys(obj);
      return keys.map(function(key) {
        var value = Object.assign({}, obj[key]);
        value.key = key;
        return value;
      });
    }
  });
  </script>
</dom-module>
